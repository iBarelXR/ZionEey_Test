<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>EagleEye XR: Fixed v3</title>
  
  <style>
    body { font-family: sans-serif; margin: 0; overflow: hidden; background-color: #333; }
    #overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8); z-index: 9999;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    #debug-log {
      position: absolute; top: 10px; left: 10px; color: yellow; 
      font-family: monospace; white-space: pre-wrap; z-index: 10000;
      pointer-events: none; background: rgba(0,0,0,0.5); padding: 5px;
    }
    button {
      padding: 20px 40px; font-size: 20px; background: #00AAFF; color: white;
      border: none; border-radius: 5px; cursor: pointer;
    }
  </style>

  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  
  <script src="https://unpkg.com/networked-aframe@^0.12.0/dist/networked-aframe.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    // Global error handler to print to screen
    window.onerror = function(msg, source, lineno, colno, error) {
      const log = document.getElementById('debug-log');
      if(log) log.innerText += `\nERROR: ${msg}`;
    };

    console.log("Initializing Firebase...");
    const firebaseConfig = {
      apiKey: "AIzaSyBdYyjQA0u8UCBRRyJog6ZMbS2motpbnLY",
      authDomain: "eagleeye-xr.firebaseapp.com",
      databaseURL: "https://eagleeye-xr-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "eagleeye-xr",
      storageBucket: "eagleeye-xr.firebasestorage.app",
      messagingSenderId: "777169462010",
      appId: "1:777169462010:web:eb20927ad1d8b8d69c5f43"
    };

    // Initialize immediately
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
      console.log("Firebase Initialized!");
    }
  </script>

  <script src="https://unpkg.com/naf-firebase-adapter@^5.0.0/dist/naf-firebase-adapter.min.js"></script>

  <script>
    // Define avatar schema
    NAF.schemas.add({
      template: '#avatar-template',
      components: ['position', 'rotation']
    });

    // 1. Calibration Component
    AFRAME.registerComponent('calibration-reset', {
      init: function() {
        const el = this.el;
        const rig = document.querySelector('#cameraRig');
        const camera = document.querySelector('[camera]');
        
        el.addEventListener('abuttondown', function() {
          const log = document.getElementById('debug-log');
          if(log) log.innerText = "Calibrating Position...";
          
          const camRot = camera.getAttribute('rotation');
          const camPos = camera.getAttribute('position');
          
          rig.setAttribute('position', { x: -camPos.x, y: 0, z: -camPos.z });
          rig.setAttribute('rotation', { x: 0, y: -camRot.y, z: 0 });
        });
      }
    });

    // 2. HUD Toggle
    AFRAME.registerComponent('hud-toggle', {
      init: function() {
        const hud = document.querySelector('#drone-hud');
        this.el.addEventListener('xbuttondown', function() {
          const isVisible = hud.getAttribute('visible');
          hud.setAttribute('visible', !isVisible);
        });
      }
    });

    // 3. Radar System
    AFRAME.registerComponent('radar-system', {
      tick: function() {
        const blipsContainer = document.querySelector('#radar-blips');
        const player = document.querySelector('[camera]');
        if (!player || !blipsContainer) return;

        blipsContainer.innerHTML = ''; // Clear old dots

        const playerPos = new THREE.Vector3();
        player.object3D.getWorldPosition(playerPos);
        const playerRotY = player.object3D.rotation.y;

        const others = document.querySelectorAll('.networked-avatar');
        others.forEach(other => {
          if (other === player) return; // Skip self
          
          const otherPos = new THREE.Vector3();
          other.object3D.getWorldPosition(otherPos);

          const dx = otherPos.x - playerPos.x;
          const dz = otherPos.z - playerPos.z;
          
          // Radar Math
          const angle = Math.atan2(dx, dz);
          const relativeAngle = angle - playerRotY;
          const radius = 0.28;
          
          const bx = Math.sin(relativeAngle) * radius;
          const by = Math.cos(relativeAngle) * radius;

          const blip = document.createElement('a-circle');
          blip.setAttribute('color', '#00FF00');
          blip.setAttribute('radius', '0.015');
          blip.setAttribute('position', `${bx} ${by} 0.01`);
          blip.setAttribute('material', 'shader: flat');
          
          blipsContainer.appendChild(blip);
        });
      }
    });
  </script>
</head>
<body>

  <div id="debug-log">System Ready. Waiting for user...</div>

  <div id="overlay">
    <h1 style="color: white;">EagleEye XR</h1>
    <button onclick="startExperience()">ENTER AR MISSION</button>
  </div>

  <a-scene 
    networked-scene="adapter: firebase; room: eagle-eye-room; debug: true;"
    renderer="colorManagement: true; alpha: true"
    xr-mode-ui="enabled: true">

    <a-assets>
      <template id="avatar-template">
        <a-entity class="networked-avatar">
          <a-tetrahedron color="#00AAFF" radius="0.15" position="0 0.4 0" material="shader: standard; emissive: #00AAFF"></a-tetrahedron>
        </a-entity>
      </template>
      <video id="drone-video" src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4" loop="true" crossorigin="anonymous"></video>
    </a-assets>

    <a-entity id="cameraRig" networked="template: #avatar-template; attachTemplateToLocal: false;">
      <a-camera position="0 1.6 0">
        <a-entity id="compass-ring" position="0 0.3 -0.5" rotation="-90 0 0">
           <a-ring radius-inner="0.28" radius-outer="0.3" color="#00AAFF" opacity="0.4" material="shader: flat; transparent: true"></a-ring>
           <a-triangle color="red" position="0 0.3 0" scale="0.03 0.03 0.03"></a-triangle>
           <a-entity id="radar-blips"></a-entity>
        </a-entity>
        <a-plane id="drone-hud" src="#drone-video" position="0.5 0.3 -1" scale="0.4 0.25 1" visible="false"></a-plane>
      </a-camera>

      <a-entity oculus-touch-controls="hand: right" calibration-reset></a-entity>
      <a-entity oculus-touch-controls="hand: left" hud-toggle></a-entity>
    </a-entity>

    <a-entity radar-system></a-entity>
  </a-scene>

  <script>
    function startExperience() {
      // Hide overlay
      document.getElementById('overlay').style.display = 'none';
      
      // Start Video
      const v = document.querySelector('#drone-video');
      if(v) v.play().catch(e => {
         document.getElementById('debug-log').innerText += "\nVideo Autoplay failed (Click interaction needed)";
      });

      // Enter VR/AR
      const scene = document.querySelector('a-scene');
      scene.enterVR(); 
    }
  </script>
</body>
</html>
