<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>EagleEye XR: v7 (Registered)</title>
  
  <style>
    body { background-color: #000; margin: 0; overflow: hidden; font-family: monospace; }
    #debug-overlay {
      position: absolute; top: 10px; left: 10px; z-index: 99999;
      color: #FFFF00; background: rgba(0,0,0,0.8); padding: 10px; 
      pointer-events: none; font-size: 14px; white-space: pre-wrap;
    }
    #start-screen {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: #222; z-index: 10000;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    button {
      padding: 20px 40px; font-size: 20px; background: #00AAFF; color: white;
      border: 2px solid white; border-radius: 8px; cursor: pointer; margin-top: 15px;
    }
  </style>

  <script>
    function log(msg) {
      const el = document.getElementById('debug-log');
      if(el) el.innerText += "\n" + msg;
      console.log(msg);
    }
    window.onerror = function(msg, url, line) {
      log(`ERR: ${msg}\nLine: ${line}`);
    };
  </script>

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/networked-aframe@^0.11.0/dist/networked-aframe.min.js" crossorigin="anonymous"></script>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js" crossorigin="anonymous"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js" crossorigin="anonymous"></script>

  <script src="https://unpkg.com/naf-firebase-adapter@^5.0.0/dist/naf-firebase-adapter.min.js" crossorigin="anonymous"></script>

  <script>
    // A. Init Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBdYyjQA0u8UCBRRyJog6ZMbS2motpbnLY",
      authDomain: "eagleeye-xr.firebaseapp.com",
      databaseURL: "https://eagleeye-xr-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "eagleeye-xr",
      storageBucket: "eagleeye-xr.firebasestorage.app",
      messagingSenderId: "777169462010",
      appId: "1:777169462010:web:eb20927ad1d8b8d69c5f43"
    };
    if (typeof firebase !== 'undefined' && !firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }

    // B. REGISTER ADAPTER (This fixes the error!)
    if (window.FirebaseAdapter) {
        NAF.adapters.register('firebase', FirebaseAdapter);
        console.log("Firebase Adapter Registered Successfully.");
    } else {
        log("CRITICAL: FirebaseAdapter library not found.");
    }

    // C. Define Schema
    if(NAF) {
        NAF.schemas.add({
            template: '#avatar-template',
            components: ['position', 'rotation']
        });
    }

    // D. Transparent Background Fix
    AFRAME.registerComponent('transparent-fix', {
      init: function() {
        this.el.sceneEl.addEventListener('enter-vr', () => {
          log("Entering AR... Background Cleared.");
          document.body.style.backgroundColor = 'transparent';
        });
      }
    });

    // E. Calibration Component
    AFRAME.registerComponent('calibration-reset', {
      init: function() {
        this.el.addEventListener('abuttondown', () => {
            log("Calibrating Co-Location...");
            const rig = document.querySelector('#cameraRig');
            const cam = document.querySelector('[camera]');
            const pos = cam.getAttribute('position');
            const rot = cam.getAttribute('rotation');
            rig.setAttribute('position', {x: -pos.x, y: 0, z: -pos.z});
            rig.setAttribute('rotation', {x: 0, y: -rot.y, z: 0});
        });
      }
    });

    // F. Radar System
    AFRAME.registerComponent('radar-system', {
      tick: function() {
        const blips = document.getElementById('radar-blips');
        const me = document.querySelector('[camera]');
        if(!me || !blips) return;
        
        blips.innerHTML = '';
        const myPos = new THREE.Vector3();
        me.object3D.getWorldPosition(myPos);
        const myRot = me.object3D.rotation.y;

        document.querySelectorAll('.networked-avatar').forEach(other => {
          if(other === me) return;
          const otherPos = new THREE.Vector3();
          other.object3D.getWorldPosition(otherPos);
          
          const dx = otherPos.x - myPos.x;
          const dz = otherPos.z - myPos.z;
          const angle = Math.atan2(dx, dz) - myRot;
          const bx = Math.sin(angle) * 0.28;
          const by = Math.cos(angle) * 0.28;
          
          const blip = document.createElement('a-circle');
          blip.setAttribute('color', '#00FF00');
          blip.setAttribute('radius', '0.015');
          blip.setAttribute('position', `${bx} ${by} 0.01`);
          blip.setAttribute('material', 'shader: flat');
          blips.appendChild(blip);
        });
      }
    });
  </script>
</head>
<body>

  <div id="debug-overlay">Log: <span id="debug-log">System Ready (v7).</span></div>

  <div id="start-screen">
    <h1>EAGLE EYE XR</h1>
    <button onclick="startAR()">START MISSION</button>
  </div>

  <a-scene 
    transparent-fix
    networked-scene="
      adapter: firebase;
      room: eagle-eye-room;
      debug: true;
      audio: false; 
    "
    renderer="colorManagement: true; alpha: true"
    xr-mode-ui="enabled: true">

    <a-assets>
      <template id="avatar-template">
        <a-entity class="networked-avatar">
          <a-tetrahedron color="#00AAFF" radius="0.15" position="0 0.4 0" material="shader: standard; emissive: #00AAFF"></a-tetrahedron>
        </a-entity>
      </template>
      <video id="drone-video" src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4" loop="true" crossorigin="anonymous"></video>
    </a-assets>

    <a-entity id="cameraRig" networked="template: #avatar-template; attachTemplateToLocal: false;">
      <a-camera position="0 1.6 0">
        <a-entity id="compass-ring" position="0 0.3 -0.5" rotation="-90 0 0">
           <a-ring radius-inner="0.28" radius-outer="0.3" color="#00AAFF" opacity="0.4" material="shader: flat; transparent: true"></a-ring>
           <a-triangle color="red" position="0 0.3 0" scale="0.03 0.03 0.03"></a-triangle>
           <a-entity id="radar-blips"></a-entity>
        </a-entity>
        <a-plane id="drone-hud" src="#drone-video" position="0.5 0.3 -1" scale="0.4 0.25 1" visible="false"></a-plane>
      </a-camera>
      
      <a-entity oculus-touch-controls="hand: right" calibration-reset></a-entity>
      
      <a-entity oculus-touch-controls="hand: left" 
        event-set__toggle="_event: xbuttondown; _target: #drone-hud; visible: !visible">
      </a-entity>
    </a-entity>

    <a-entity radar-system></a-entity>
  </a-scene>

  <script>
    function startAR() {
        document.getElementById('start-screen').style.display = 'none';
        const v = document.querySelector('#drone-video');
        if(v) v.play();
        document.querySelector('a-scene').enterVR();
    }
  </script>
</body>
</html>
