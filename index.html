<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>EagleEye XR: v5 Stable</title>
  
  <style>
    body { font-family: sans-serif; margin: 0; overflow: hidden; background-color: #000; }
    
    #debug-overlay {
      position: absolute; top: 10px; left: 10px; z-index: 99999;
      color: #FFFF00; font-family: monospace; font-size: 16px;
      background: rgba(0,0,0,0.7); padding: 10px; pointer-events: none;
      max-width: 80%; white-space: pre-wrap;
    }

    #start-screen {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: #222; z-index: 10000;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }

    button {
      padding: 20px 50px; font-size: 24px; background: #00AAFF; color: white;
      border: 2px solid white; border-radius: 10px; cursor: pointer;
      margin-top: 20px;
    }
    
    button:disabled { background: #555; cursor: wait; }
  </style>

  <script>
    function log(msg) {
      const el = document.getElementById('debug-log');
      if(el) el.innerText += "\n" + msg;
      console.log(msg);
    }
    window.onerror = function(e) {
      log("CRITICAL ERROR: " + e);
    };
  </script>

  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.5.0/socket.io.slim.js"></script>
  <script src="https://unpkg.com/networked-aframe@^0.12.0/dist/networked-aframe.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBdYyjQA0u8UCBRRyJog6ZMbS2motpbnLY",
      authDomain: "eagleeye-xr.firebaseapp.com",
      databaseURL: "https://eagleeye-xr-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "eagleeye-xr",
      storageBucket: "eagleeye-xr.firebasestorage.app",
      messagingSenderId: "777169462010",
      appId: "1:777169462010:web:eb20927ad1d8b8d69c5f43"
    };
    
    // Check if loaded
    if (typeof firebase !== 'undefined') {
      firebase.initializeApp(firebaseConfig);
    } else {
      setTimeout(() => log("Error: Firebase SDK not loaded"), 1000);
    }
  </script>

  <script src="https://unpkg.com/naf-firebase-adapter@^5.0.0/dist/naf-firebase-adapter.min.js"></script>

  <script>
    // Define Schema
    NAF.schemas.add({
      template: '#avatar-template',
      components: ['position', 'rotation']
    });

    // Calibration
    AFRAME.registerComponent('calibration-reset', {
      init: function() {
        this.el.addEventListener('abuttondown', () => {
          log("Calibrating...");
          const rig = document.querySelector('#cameraRig');
          const cam = document.querySelector('[camera]');
          const rot = cam.getAttribute('rotation');
          const pos = cam.getAttribute('position');
          rig.setAttribute('position', {x: -pos.x, y: 0, z: -pos.z});
          rig.setAttribute('rotation', {x: 0, y: -rot.y, z: 0});
        });
      }
    });

    // Radar
    AFRAME.registerComponent('radar-system', {
      tick: function() {
        const blips = document.querySelector('#radar-blips');
        const me = document.querySelector('[camera]');
        if(!me || !blips) return;
        
        blips.innerHTML = '';
        const myPos = new THREE.Vector3();
        me.object3D.getWorldPosition(myPos);
        const myRot = me.object3D.rotation.y;

        document.querySelectorAll('.networked-avatar').forEach(other => {
          if(other === me) return;
          const otherPos = new THREE.Vector3();
          other.object3D.getWorldPosition(otherPos);
          
          const dx = otherPos.x - myPos.x;
          const dz = otherPos.z - myPos.z;
          const angle = Math.atan2(dx, dz) - myRot;
          
          const bx = Math.sin(angle) * 0.28;
          const by = Math.cos(angle) * 0.28;
          
          const blip = document.createElement('a-circle');
          blip.setAttribute('color', '#00FF00');
          blip.setAttribute('radius', '0.015');
          blip.setAttribute('position', `${bx} ${by} 0.01`);
          blip.setAttribute('material', 'shader: flat');
          blips.appendChild(blip);
        });
      }
    });

    // TRANSPARENCY ENFORCER (Fixes Black Screen)
    AFRAME.registerComponent('ar-transparent', {
      init: function () {
        this.el.sceneEl.addEventListener('enter-vr', () => {
          log("Entering AR - Forcing Transparency");
          document.body.style.backgroundColor = 'transparent';
          this.el.sceneEl.canvas.style.backgroundColor = 'transparent';
        });
      }
    });
  </script>
</head>
<body>

  <div id="debug-overlay">Log: <span id="debug-log">Loading...</span></div>

  <div id="start-screen">
    <h1>EAGLE EYE XR</h1>
    <h3 style="color: #aaa;">Status: <span id="status-text">Initializing...</span></h3>
    <button id="btn-start" disabled onclick="enterAR()">WAITING...</button>
  </div>

  <a-scene 
    ar-transparent
    renderer="colorManagement: true; alpha: true"
    xr-mode-ui="enabled: true">
    
    <a-assets>
      <template id="avatar-template">
        <a-entity class="networked-avatar">
          <a-tetrahedron color="#00AAFF" radius="0.15" position="0 0.4 0" material="shader: standard; emissive: #00AAFF"></a-tetrahedron>
        </a-entity>
      </template>
      <video id="drone-video" src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4" loop="true" crossorigin="anonymous"></video>
    </a-assets>

    <a-entity id="network-manager"></a-entity>

    <a-entity id="cameraRig" networked="template: #avatar-template; attachTemplateToLocal: false;">
      <a-camera position="0 1.6 0">
        <a-entity id="compass-ring" position="0 0.3 -0.5" rotation="-90 0 0">
           <a-ring radius-inner="0.28" radius-outer="0.3" color="#00AAFF" opacity="0.4" material="shader: flat; transparent: true"></a-ring>
           <a-triangle color="red" position="0 0.3 0" scale="0.03 0.03 0.03"></a-triangle>
           <a-entity id="radar-blips"></a-entity>
        </a-entity>
        <a-plane id="drone-hud" src="#drone-video" position="0.5 0.3 -1" scale="0.4 0.25 1" visible="false"></a-plane>
      </a-camera>
      <a-entity oculus-touch-controls="hand: right" calibration-reset></a-entity>
      <a-entity oculus-touch-controls="hand: left" hud-toggle></a-entity>
    </a-entity>

    <a-entity radar-system></a-entity>
  </a-scene>

  <script>
    // Wait for everything to load
    window.addEventListener('load', () => {
      const btn = document.getElementById('btn-start');
      const status = document.getElementById('status-text');
      
      if (typeof firebase !== 'undefined' && typeof NAF !== 'undefined') {
        log("System Ready.");
        status.innerText = "Ready to Deploy";
        status.style.color = "#00FF00";
        btn.disabled = false;
        btn.innerText = "ENTER MISSION";
      } else {
        log("Load Failed. Check Internet.");
        status.innerText = "Error: Libs missing";
        status.style.color = "red";
      }
    });

    function enterAR() {
      // 1. Hide Menu
      document.getElementById('start-screen').style.display = 'none';
      
      // 2. Play Video
      const v = document.querySelector('#drone-video');
      if(v) v.play();

      // 3. Attach Network Component NOW (Prevents race condition)
      log("Connecting to Network...");
      const scene = document.querySelector('a-scene');
      scene.setAttribute('networked-scene', 'adapter: firebase; room: eagle-eye-room; debug: true;');

      // 4. Enter VR
      scene.enterVR();
    }
  </script>
</body>
</html>
