<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>EagleEye XR: Debug v4</title>
  
  <style>
    body { font-family: monospace; margin: 0; overflow: hidden; background-color: #111; color: white; }
    #debug-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: auto;
      background: rgba(0,0,0,0.85); z-index: 99999; padding: 10px;
      pointer-events: none; /* Let clicks pass through */
      white-space: pre-wrap; font-size: 14px; color: #FFFF00;
    }
    #start-screen {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: #222; z-index: 10000;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    button {
      padding: 20px 40px; font-size: 24px; background: #00AAFF; color: white;
      border: 2px solid white; border-radius: 8px; cursor: pointer;
    }
  </style>

  <script>
    window.onerror = function(msg, url, lineNo, columnNo, error) {
      const log = document.getElementById('debug-log');
      if (log) log.innerText += `\n[CRITICAL ERROR]: ${msg}\nLine: ${lineNo}`;
      return false;
    };
    window.onload = function() {
        document.getElementById('debug-log').innerText += "\n> Page Loaded. Initializing...";
    }
  </script>

  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  
  <script src="https://unpkg.com/networked-aframe@^0.12.0/dist/networked-aframe.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    try {
        const firebaseConfig = {
          apiKey: "AIzaSyBdYyjQA0u8UCBRRyJog6ZMbS2motpbnLY",
          authDomain: "eagleeye-xr.firebaseapp.com",
          databaseURL: "https://eagleeye-xr-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "eagleeye-xr",
          storageBucket: "eagleeye-xr.firebasestorage.app",
          messagingSenderId: "777169462010",
          appId: "1:777169462010:web:eb20927ad1d8b8d69c5f43"
        };
        
        // Check if Firebase is loaded
        if (typeof firebase === 'undefined') {
            throw new Error("Firebase SDK failed to load.");
        }

        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
          console.log("Firebase Initialized");
        }
    } catch (e) {
        // We will catch this in the body onload if screen is white
        console.error(e);
    }
  </script>

  <script src="https://unpkg.com/naf-firebase-adapter@^5.0.0/dist/naf-firebase-adapter.min.js"></script>

  <script>
    // Define Schema
    if (NAF) {
        NAF.schemas.add({
        template: '#avatar-template',
        components: ['position', 'rotation']
        });
    } else {
        console.error("NAF not defined");
    }

    // Calibration Component
    AFRAME.registerComponent('calibration-reset', {
      init: function() {
        const el = this.el;
        const rig = document.querySelector('#cameraRig');
        const camera = document.querySelector('[camera]');
        
        el.addEventListener('abuttondown', function() {
          document.getElementById('debug-log').innerText += "\n> Calibrating Position...";
          const camRot = camera.getAttribute('rotation');
          const camPos = camera.getAttribute('position');
          rig.setAttribute('position', { x: -camPos.x, y: 0, z: -camPos.z });
          rig.setAttribute('rotation', { x: 0, y: -camRot.y, z: 0 });
        });
      }
    });

    // HUD Toggle
    AFRAME.registerComponent('hud-toggle', {
      init: function() {
        const hud = document.querySelector('#drone-hud');
        this.el.addEventListener('xbuttondown', function() {
          const isVisible = hud.getAttribute('visible');
          hud.setAttribute('visible', !isVisible);
        });
      }
    });

    // Radar System
    AFRAME.registerComponent('radar-system', {
      tick: function() {
        const blipsContainer = document.querySelector('#radar-blips');
        const player = document.querySelector('[camera]');
        if (!player || !blipsContainer) return;

        blipsContainer.innerHTML = ''; 

        const playerPos = new THREE.Vector3();
        player.object3D.getWorldPosition(playerPos);
        const playerRotY = player.object3D.rotation.y;

        const others = document.querySelectorAll('.networked-avatar');
        others.forEach(other => {
          if (other === player) return; 
          
          const otherPos = new THREE.Vector3();
          other.object3D.getWorldPosition(otherPos);

          const dx = otherPos.x - playerPos.x;
          const dz = otherPos.z - playerPos.z;
          const angle = Math.atan2(dx, dz);
          const relativeAngle = angle - playerRotY;
          const radius = 0.28;
          
          const bx = Math.sin(relativeAngle) * radius;
          const by = Math.cos(relativeAngle) * radius;

          const blip = document.createElement('a-circle');
          blip.setAttribute('color', '#00FF00');
          blip.setAttribute('radius', '0.015');
          blip.setAttribute('position', `${bx} ${by} 0.01`);
          blip.setAttribute('material', 'shader: flat');
          
          blipsContainer.appendChild(blip);
        });
      }
    });
  </script>
</head>
<body>

  <div id="debug-overlay">
    <strong>SYSTEM LOG:</strong>
    <span id="debug-log">Waiting for scripts...</span>
  </div>

  <div id="start-screen">
    <h1>EAGLE EYE XR</h1>
    <button onclick="startAR()">ENTER AR</button>
  </div>

  <a-scene 
    networked-scene="adapter: firebase; room: eagle-eye-room; debug: true;"
    renderer="colorManagement: true; alpha: true"
    xr-mode-ui="enabled: true">

    <a-assets>
      <template id="avatar-template">
        <a-entity class="networked-avatar">
          <a-tetrahedron color="#00AAFF" radius="0.15" position="0 0.4 0" material="shader: standard; emissive: #00AAFF"></a-tetrahedron>
        </a-entity>
      </template>
      <video id="drone-video" src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4" loop="true" crossorigin="anonymous"></video>
    </a-assets>

    <a-entity id="cameraRig" networked="template: #avatar-template; attachTemplateToLocal: false;">
      <a-camera position="0 1.6 0">
        <a-entity id="compass-ring" position="0 0.3 -0.5" rotation="-90 0 0">
           <a-ring radius-inner="0.28" radius-outer="0.3" color="#00AAFF" opacity="0.4" material="shader: flat; transparent: true"></a-ring>
           <a-triangle color="red" position="0 0.3 0" scale="0.03 0.03 0.03"></a-triangle>
           <a-entity id="radar-blips"></a-entity>
        </a-entity>
        <a-plane id="drone-hud" src="#drone-video" position="0.5 0.3 -1" scale="0.4 0.25 1" visible="false"></a-plane>
      </a-camera>

      <a-entity oculus-touch-controls="hand: right" calibration-reset></a-entity>
      <a-entity oculus-touch-controls="hand: left" hud-toggle></a-entity>
    </a-entity>

    <a-entity radar-system></a-entity>
  </a-scene>

  <script>
    // Init Log
    document.getElementById('debug-log').innerText += "\n> Body Parsed.";

    function startAR() {
      document.getElementById('start-screen').style.display = 'none';
      document.getElementById('debug-log').innerText += "\n> Entering Scene...";
      
      const v = document.querySelector('#drone-video');
      if(v) v.play().catch(e => document.getElementById('debug-log').innerText += "\nVideo warning: " + e);
      
      const scene = document.querySelector('a-scene');
      scene.enterVR();
    }
  </script>
</body>
</html>
