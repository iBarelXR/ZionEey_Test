<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Quest 3 AR: Red vs Blue</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- A-Frame 1.5.0 -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        body { font-family: sans-serif; background-color: transparent; }
        
        /* RESTORED DEFAULT BUTTON */
        .a-enter-vr { 
            position: fixed; bottom: 20px; right: 20px; z-index: 9999;
        }
        
        #overlay {
            position: absolute; z-index: 1000; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); color: white; display: flex; flex-direction: column;
            align-items: center; justify-content: center; text-align: center;
            pointer-events: auto;
        }
        .btn {
            background: #444; color: white; border: 2px solid white; padding: 15px 30px;
            font-size: 1.2rem; margin: 10px; cursor: pointer; border-radius: 8px;
        }
        .btn-blue { background: #0055ff; border-color: #002a80; }
        .btn-red { background: #d32f2f; border-color: #8e0000; }
        .hidden { display: none !important; }
        #status { 
            position: absolute; bottom: 20px; left: 20px; color: lime; 
            z-index: 999; font-weight: bold; text-shadow: 1px 1px 2px black; font-family: monospace; font-size: 1.2em;
            pointer-events: none;
        }
        .calibration-instruction {
            background: rgba(255, 255, 0, 0.2);
            border: 1px solid yellow;
            padding: 10px; margin-bottom: 20px; border-radius: 5px; max-width: 80%;
        }
    </style>
</head>
<body>

    <!-- UI Overlay -->
    <div id="overlay">
        <h1>Quest 3 AR Battle</h1>
        
        <div class="calibration-instruction">
            <h3>ðŸŽ¯ Precision Calibration</h3>
            <p>1. Stick a marker (QR Code or X) on a wall or table.</p>
            <p>2. Hold your <strong>RIGHT Controller</strong> against the marker.</p>
            <p>3. Press <strong>TRIGGER</strong> to snap the world to that point.</p>
        </div>
        
        <div id="setup-controls">
            <button class="btn btn-blue" onclick="startAR('blue')">Join Blue Team (M4)</button>
            <button class="btn btn-red" onclick="startAR('red')">Join Red Team (AK47)</button>
        </div>
        <p id="loading-text" class="hidden">Requesting AR Session...</p>
    </div>

    <div id="status">Hold Right Controller on Marker & Pull Trigger</div>

    <!-- 3D Scene -->
    <a-scene 
        renderer="alpha: true; antialias: true; colorManagement: true; sortObjects: true;"
        webxr="optionalFeatures: dom-overlay, hit-test, immersive-ar; overlayElement: #overlay; requiredFeatures: local-floor"
        vr-mode-ui="enabled: true"
        background="color: transparent">
        
        <!-- Transparent Skybox -->
        <a-sky color="#000000" opacity="0"></a-sky>

        <!-- LIGHTING: High Intensity for AR -->
        <a-light type="ambient" intensity="2" color="#ffffff"></a-light>
        <a-light type="directional" intensity="1.5" position="-1 2 1"></a-light>

        <a-assets>
            <!-- Blue Diamond (X-Ray Enabled, FLAT shader for max visibility) -->
            <a-mixin id="blue-indicator" geometry="primitive: octahedron; radius: 0.15" material="shader: flat; color: #00aaff; opacity: 1.0; depthTest: false"></a-mixin>
            <!-- Red Triangle (X-Ray Enabled, FLAT shader for max visibility) -->
            <a-mixin id="red-indicator" geometry="primitive: cone; radiusBottom: 0.01; radiusTop: 0.15; height: 0.3" material="shader: flat; color: #ff3333; opacity: 1.0; depthTest: false"></a-mixin>
        </a-assets>

        <!-- LOCAL PLAYER RIG -->
        <!-- Added auto-spawn component to ensure objects appear in front of you on start -->
        <a-entity id="local-rig" auto-spawn>
            <a-camera id="local-head" position="0 1.6 0" look-controls="pointerLockEnabled: false">
                 <!-- HUD TEST: Moved further away (-2m) to prevent "stuck to nose" feeling -->
                 <a-text value="AR SYSTEM ONLINE" position="0 0.5 -2" scale="0.5 0.5 0.5" align="center" color="lime" material="shader: flat; depthTest: false"></a-text>
            </a-camera>
            
            <a-entity id="left-hand" laser-controls="hand: left" raycaster="showLine: false"></a-entity>
            
            <!-- Right Hand (Weapon + Calibration) -->
            <a-entity id="right-hand" laser-controls="hand: right" calibration-listener raycaster="showLine: false">
                <!-- Weapon spawned here -->
            </a-entity>
        </a-entity>


        <!-- WORLD ROOT (The Anchor) -->
        <!-- Start at a default position, but auto-spawn will move this -->
        <a-entity id="world-root" position="0 1.5 -1.5">
            
            <!-- Calibration Visual Marker - Solid and Bright -->
            <a-entity id="calibration-marker" visible="true">
                <!-- Added depthTest: false to see through walls/tables -->
                <a-box position="0 0 0" width="0.2" height="0.2" depth="0.2" material="shader: flat; color: yellow; opacity: 1.0; depthTest: false"></a-box>
                <a-text value="SYNC POINT" align="center" position="0 0.25 0" scale="0.5 0.5 0.5" color="yellow" material="shader: flat; depthTest: false"></a-text>
                <a-cylinder height="0.01" radius="0.3" material="shader: flat; color: yellow; opacity: 0.3; depthTest: false"></a-cylinder>
                <a-arrow direction="0 0 -1" length="0.5" color="yellow" material="shader: flat; depthTest: false"></a-arrow>
            </a-entity>

            <!-- Remote Players -->
            <a-entity id="remote-players"></a-entity>

        </a-entity>

        <!-- SYNC SYSTEM -->
        <a-entity id="sync-system" network-sync></a-entity>

    </a-scene>

    <script>
        // --- 0. CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCgzwyHW0gPmsdp5sKFPL2WpUqah02OAf4",
            authDomain: "zioneye-prototype.firebaseapp.com",
            projectId: "zioneye-prototype",
            storageBucket: "zioneye-prototype.firebasestorage.app",
            messagingSenderId: "356865086206",
            appId: "1:356865086206:web:d611c8deb6a98070dc0baf",
            measurementId: "G-P1XL9VQN79"
        };

        let db, auth, currentUserId, myTeam = null;

        // --- 1. WEAPON MODELS (FLAT SHADER for AR Visibility) ---
        function getWeaponContent(team) {
            if (team === 'blue') {
                return `
                    <a-box material="shader: flat; color: #1a1a1a" depth="0.4" height="0.08" width="0.05" position="0 0 -0.1"></a-box>
                    <a-cylinder material="shader: flat; color: #111" height="0.35" radius="0.015" rotation="90 0 0" position="0 0.02 -0.35"></a-cylinder>
                    <a-box material="shader: flat; color: #222" depth="0.05" height="0.2" width="0.04" position="0 -0.12 -0.1" rotation="10 0 0"></a-box>
                    <a-box material="shader: flat; color: #111" depth="0.15" height="0.1" width="0.04" position="0 -0.05 0.2"></a-box>
                    <a-box material="shader: flat; color: #444" depth="0.1" height="0.04" width="0.04" position="0 0.08 -0.1"></a-box>
                `; 
            } else {
                return `
                    <a-box material="shader: flat; color: #2a2a2a" depth="0.4" height="0.08" width="0.05" position="0 0 -0.1"></a-box>
                    <a-box material="shader: flat; color: #8B4513" depth="0.2" height="0.06" width="0.055" position="0 0 -0.3"></a-box>
                    <a-cylinder material="shader: flat; color: #111" height="0.4" radius="0.012" rotation="90 0 0" position="0 0.02 -0.4"></a-cylinder>
                    <a-box material="shader: flat; color: #333" depth="0.06" height="0.22" width="0.04" position="0 -0.12 -0.15" rotation="25 0 0"></a-box>
                    <a-box material="shader: flat; color: #8B4513" depth="0.2" height="0.1" width="0.04" position="0 -0.08 0.25" rotation="-15 0 0"></a-box>
                `;
            }
        }

        // --- 2. AUTO-SPAWN (FIX FOR INVISIBLE OBJECTS) ---
        AFRAME.registerComponent('auto-spawn', {
            init: function() {
                const scene = this.el.sceneEl;
                scene.addEventListener('enter-vr', () => {
                    // Wait a moment for headset to initialize position
                    setTimeout(() => {
                        const camera = document.getElementById('local-head');
                        const worldRoot = document.getElementById('world-root');
                        
                        // Get Camera World Position/Rotation
                        const camPos = new THREE.Vector3();
                        const camQuat = new THREE.Quaternion();
                        camera.object3D.getWorldPosition(camPos);
                        camera.object3D.getWorldQuaternion(camQuat);
                        
                        // Calculate position 1.5 meters in front of user
                        const direction = new THREE.Vector3(0, 0, -1.5);
                        direction.applyQuaternion(camQuat);
                        // Flatten Y so it spawns at eye level but horizontally
                        direction.y = 0; 
                        
                        // New Position: CamPos + Direction
                        const newPos = new THREE.Vector3().copy(camPos).add(direction);
                        // Keep Y fixed at roughly eye level or relative to floor?
                        // Let's keep it relative to camera height for visibility
                        newPos.y = camPos.y; 

                        // Move World Root
                        worldRoot.object3D.position.copy(newPos);
                        
                        // Face the user (Yaw only)
                        const euler = new THREE.Euler().setFromQuaternion(camQuat, 'YXZ');
                        worldRoot.object3D.rotation.set(0, euler.y, 0);

                    }, 2000); // 2 second delay to ensure tracking is stable
                });
            }
        });

        // --- 3. CALIBRATION ---
        AFRAME.registerComponent('calibration-listener', {
            init: function () {
                this.el.addEventListener('triggerdown', this.calibrate.bind(this));
            },
            calibrate: function () {
                const worldRoot = document.getElementById('world-root');
                const controller = this.el.object3D;
                
                controller.updateMatrixWorld(true);
                
                const pos = controller.position;
                const rot = controller.rotation;
                
                worldRoot.object3D.position.set(pos.x, pos.y, pos.z);
                worldRoot.object3D.rotation.set(0, rot.y, 0); 

                const status = document.getElementById('status');
                status.innerText = "Synced! World moved to Marker.";
                status.style.color = "lime";
                
                const marker = document.getElementById('calibration-marker');
                marker.setAttribute('visible', 'true');
            }
        });

        // --- 4. NETWORK SYNC SYSTEM ---
        AFRAME.registerComponent('network-sync', {
            init: function() {
                this.lastTime = 0;
            },
            tick: function () {
                if (!currentUserId || !db) return;

                const now = Date.now();
                if (now - this.lastTime < 80) return; 
                this.lastTime = now;

                const head = document.getElementById('local-head');
                const hand = document.getElementById('right-hand');
                const worldRoot = document.getElementById('world-root');

                head.object3D.updateMatrixWorld(true);
                hand.object3D.updateMatrixWorld(true);
                worldRoot.object3D.updateMatrixWorld(true);

                // RELATIVE MATH
                const rootInv = new THREE.Matrix4().copy(worldRoot.object3D.matrixWorld).invert();
                
                // Head
                const headWorld = head.object3D.matrixWorld;
                const headRel = new THREE.Matrix4().multiplyMatrices(rootInv, headWorld);
                const hPos = new THREE.Vector3(); const hQuat = new THREE.Quaternion(); const hScale = new THREE.Vector3();
                headRel.decompose(hPos, hQuat, hScale);
                const hRot = new THREE.Euler().setFromQuaternion(hQuat);

                // Hand
                const handWorld = hand.object3D.matrixWorld;
                const handRel = new THREE.Matrix4().multiplyMatrices(rootInv, handWorld);
                const wPos = new THREE.Vector3(); const wQuat = new THREE.Quaternion(); const wScale = new THREE.Vector3();
                handRel.decompose(wPos, wQuat, wScale);
                const wRot = new THREE.Euler().setFromQuaternion(wQuat);

                db.collection('players').doc(currentUserId).update({
                    x: hPos.x, y: hPos.y, z: hPos.z,
                    rotX: hRot.x, rotY: hRot.y, rotZ: hRot.z,
                    
                    handX: wPos.x, handY: wPos.y, handZ: wPos.z,
                    handRotX: wRot.x, handRotY: wRot.y, handRotZ: wRot.z,
                    
                    lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        });

        // --- 5. SESSION START & LOGIC ---

        function initFirebase() {
            if (!firebase.apps.length) {
                try {
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.firestore();
                    auth = firebase.auth();
                } catch (e) {
                    console.error("Firebase Init Error:", e);
                    return false;
                }
            }
            return true;
        }

        async function startAR(team) {
            // 1. START AR IMMEDIATELY (Capture User Gesture)
            document.getElementById('setup-controls').classList.add('hidden');
            document.getElementById('loading-text').classList.remove('hidden');

            const scene = document.querySelector('a-scene');
            
            // Attempt Manual AR Launch with proper Dom Overlay
            if (navigator.xr) {
                try {
                    // This request MUST happen in the direct click event handler
                    const session = await navigator.xr.requestSession('immersive-ar', {
                        optionalFeatures: ['dom-overlay', 'hit-test', 'local-floor'],
                        domOverlay: { root: document.body } 
                    });
                    
                    scene.renderer.xr.setSession(session);
                    
                } catch (e) {
                    console.warn("AR Launch Failed, falling back to A-Frame enterVR:", e);
                    scene.enterVR(); // Fallback
                }
            } else {
                scene.enterVR(); 
            }

            // 2. NOW DO FIREBASE AUTH (Background)
            if (!initFirebase()) return;

            try {
                // Anonymous Login
                const userCred = await auth.signInAnonymously();
                currentUserId = userCred.user.uid;
                myTeam = team;

                // Spawn Local Weapon
                const hand = document.getElementById('right-hand');
                // Clear existing if any
                while (hand.firstChild) { hand.removeChild(hand.firstChild); }
                
                const weapon = document.createElement('a-entity');
                weapon.innerHTML = getWeaponContent(team);
                weapon.setAttribute('rotation', '-10 0 0');
                hand.appendChild(weapon);

                // DB Init
                await db.collection('players').doc(currentUserId).set({
                    team: team,
                    x: 0, y: 0, z: 0, rotY: 0,
                    active: true,
                    lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Listen
                db.collection('players').onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.doc.id === currentUserId) return;
                        if (change.type === 'added') createRemotePlayer(change.doc.id, change.doc.data());
                        if (change.type === 'modified') updateRemotePlayer(change.doc.id, change.doc.data());
                        if (change.type === 'removed') removeRemotePlayer(change.doc.id);
                    });
                });
                
                // Hide Overlay once everything is ready
                document.getElementById('overlay').style.display = 'none';

            } catch (error) {
                console.error("Auth Error:", error);
                alert("Auth Error: " + error.message);
                // Re-show controls if auth fails
                document.getElementById('setup-controls').classList.remove('hidden');
                document.getElementById('overlay').style.display = 'flex';
            }
        }

        // --- 6. REMOTE PLAYER VISUALS ---

        function createRemotePlayer(id, data) {
            const container = document.getElementById('remote-players');
            const el = document.createElement('a-entity');
            el.setAttribute('id', `player-${id}`);

            // 1. Team Indicator
            const indicator = document.createElement('a-entity');
            indicator.classList.add('indicator-head'); // Add class for easy finding
            
            if (data.team === 'blue') {
                indicator.setAttribute('mixin', 'blue-indicator');
                indicator.setAttribute('position', '0 0.5 0'); 
                if (myTeam === 'red') indicator.setAttribute('visible', false);
            } else {
                indicator.setAttribute('mixin', 'red-indicator');
                indicator.setAttribute('position', '0 0.5 0'); 
                indicator.setAttribute('visible', true);
            }
            el.appendChild(indicator);

            // 2. Weapon
            const handEnt = document.createElement('a-entity');
            handEnt.classList.add('remote-hand');
            const weaponEnt = document.createElement('a-entity');
            weaponEnt.innerHTML = getWeaponContent(data.team);
            weaponEnt.setAttribute('rotation', '-10 0 0');
            handEnt.appendChild(weaponEnt);
            el.appendChild(handEnt);

            container.appendChild(el);
        }

        function updateRemotePlayer(id, data) {
            const el = document.getElementById(`player-${id}`);
            if (el) {
                // FORCE RESET Wrapper Position
                el.object3D.position.set(0, 0, 0);
                el.object3D.rotation.set(0, 0, 0);

                // Move Indicator (Head)
                const indicator = el.querySelector('.indicator-head');
                if (indicator) {
                     indicator.object3D.position.set(data.x, data.y, data.z);
                     indicator.object3D.rotation.set(0, data.rotY, 0); 
                     
                     if (data.team !== 'blue') {
                        indicator.object3D.rotation.x = Math.PI; 
                     }
                }
                
                // Move Hand (Weapon)
                const hand = el.querySelector('.remote-hand');
                if (hand && data.handX !== undefined) {
                    hand.object3D.position.set(data.handX, data.handY, data.handZ);
                    hand.object3D.rotation.set(data.handRotX, data.handRotY, data.handRotZ);
                }
            }
        }

        function removeRemotePlayer(id) {
            const el = document.getElementById(`player-${id}`);
            if (el) el.remove();
        }
    </script>
</body>
</html>
