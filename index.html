<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Quest 3 AR: Red vs Blue</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- A-Frame 1.5.0 -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        body { font-family: sans-serif; }
        #overlay {
            position: absolute; z-index: 1000; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); color: white; display: flex; flex-direction: column;
            align-items: center; justify-content: center; text-align: center;
        }
        .btn {
            background: #444; color: white; border: 2px solid white; padding: 15px 30px;
            font-size: 1.2rem; margin: 10px; cursor: pointer; border-radius: 8px;
        }
        .btn-blue { background: #0055ff; border-color: #002a80; }
        .btn-red { background: #d32f2f; border-color: #8e0000; }
        .hidden { display: none !important; }
        #status { 
            position: absolute; bottom: 20px; left: 20px; color: yellow; 
            z-index: 999; font-weight: bold; text-shadow: 1px 1px 2px black; font-family: monospace; font-size: 1.2em;
        }
        .calibration-instruction {
            background: rgba(255, 255, 0, 0.2);
            border: 1px solid yellow;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
    </style>
</head>
<body>

    <!-- UI Overlay -->
    <div id="overlay">
        <h1>Quest 3 AR Battle</h1>
        
        <div class="calibration-instruction">
            <h3>ðŸŽ¯ Precision Calibration</h3>
            <p>1. Stick a marker (QR Code or X) on a wall or table.</p>
            <p>2. Hold your controller <strong>against the marker</strong>.</p>
            <p>3. Press <strong>TRIGGER</strong> to snap the world to that point.</p>
        </div>
        
        <div id="setup-controls">
            <!-- PASTE FIREBASE CONFIG HERE OR EDIT CODE -->
            
            <button class="btn btn-blue" onclick="joinGame('blue')">Join Blue Team (M4)</button>
            <button class="btn btn-red" onclick="joinGame('red')">Join Red Team (AK47)</button>
        </div>
        <p id="loading-text" class="hidden">Initializing...</p>
    </div>

    <div id="status">Hold Controller on Marker & Pull Trigger</div>

    <script>
        // --- CALIBRATION COMPONENT ---
        // Moves the #world-root to match the controller's physical location
        AFRAME.registerComponent('calibration-listener', {
            init: function () {
                this.el.addEventListener('triggerdown', this.calibrate.bind(this));
            },
            calibrate: function () {
                const worldRoot = document.getElementById('world-root');
                const controller = this.el.object3D;
                
                // 1. Get Controller World Position/Rotation (which is actually local to the camera rig parent)
                const pos = controller.position;
                const rot = controller.rotation;

                // 2. Move the World Root to this position
                // This makes the "Virtual Origin" (0,0,0) appear exactly at the controller tip
                worldRoot.object3D.position.set(pos.x, pos.y, pos.z);
                
                // 3. Align Rotation (Yaw Only)
                // We keep X and Z rotation flat so the floor doesn't tilt, only the direction resets
                worldRoot.object3D.rotation.set(0, rot.y, 0);

                // Feedback
                const status = document.getElementById('status');
                status.innerText = "Target Synced! World moved to Controller.";
                status.style.color = "lime";
                
                // Flash the marker to show success
                const marker = document.getElementById('calibration-marker');
                marker.setAttribute('visible', 'true');
                setTimeout(() => marker.setAttribute('visible', 'false'), 2000);
            }
        });
    </script>

    <!-- 3D Scene -->
    <a-scene webxr="optionalFeatures: dom-overlay; overlayElement: #status; requiredFeatures: local-floor" background="color: transparent">
        
        <a-assets>
            <a-mixin id="blue-indicator" geometry="primitive: octahedron; radius: 0.15" material="color: #00aaff; shader: flat; opacity: 0.9"></a-mixin>
            <a-mixin id="red-indicator" geometry="primitive: cone; radiusBottom: 0.01; radiusTop: 0.15; height: 0.3" material="color: #ff3333; shader: flat; opacity: 0.9" rotation="180 0 0"></a-mixin>
        </a-assets>

        <!-- LOCAL PLAYER RIG (This is YOU in physical space) -->
        <!-- We do NOT move this. The rig represents the raw Quest tracking. -->
        <a-entity id="local-rig" position="0 0 0">
            <a-camera id="local-head" position="0 1.6 0" look-controls="pointerLockEnabled: false"></a-camera>
            
            <!-- Controllers with Calibration Listener -->
            <a-entity id="right-hand" laser-controls="hand: right" calibration-listener raycaster="showLine: false"></a-entity>
            <a-entity id="left-hand" laser-controls="hand: left" calibration-listener raycaster="showLine: false"></a-entity>
        </a-entity>


        <!-- WORLD ROOT (This is the Game Universe) -->
        <!-- We move THIS container to align with the real world -->
        <a-entity id="world-root" position="0 0 0">
            
            <!-- Calibration Visual Marker (Shows where 0,0,0 is) -->
            <a-entity id="calibration-marker" visible="true">
                <a-box position="0 0 0" width="0.1" height="0.1" depth="0.1" color="yellow" wireframe="true"></a-box>
                <a-text value="SYNC POINT" align="center" position="0 0.2 0" scale="0.3 0.3 0.3" color="yellow"></a-text>
                <a-cylinder height="0.01" radius="0.2" color="yellow" opacity="0.3"></a-cylinder>
            </a-entity>

            <!-- Remote Players will be spawned INSIDE here -->
            <a-entity id="remote-players"></a-entity>

        </a-entity>

    </a-scene>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "SENDER_ID",
            appId: "APP_ID"
        };

        let db, auth, currentUserId, myTeam = null;

        function initFirebase() {
            if(firebaseConfig.apiKey === "YOUR_API_KEY") {
                alert("Please edit HTML and add Firebase keys!");
                return false;
            }
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            return true;
        }

        async function joinGame(team) {
            if (!initFirebase()) return;
            
            document.getElementById('setup-controls').classList.add('hidden');
            document.getElementById('loading-text').classList.remove('hidden');

            try {
                const userCred = await auth.signInAnonymously();
                currentUserId = userCred.user.uid;
                myTeam = team;

                // Create player doc
                await db.collection('players').doc(currentUserId).set({
                    team: team,
                    // We init at 0,0,0 but the update loop will fix it
                    x: 0, y: 0, z: 0,
                    rotX: 0, rotY: 0, rotZ: 0,
                    active: true
                });

                spawnLocalWeapon(team);
                startGameLoop(); // Start syncing
                
                document.getElementById('overlay').classList.add('hidden');
                
                // Start AR
                const scene = document.querySelector('a-scene');
                scene.enterVR();

            } catch (error) {
                console.error("Error:", error);
                alert("Login Error: " + error.message);
            }
        }

        // Procedural Weapon Generation
        function spawnLocalWeapon(team) {
            const hand = document.getElementById('right-hand');
            const weapon = document.createElement('a-entity');
            
            if (team === 'blue') {
                // M4 Carbine
                weapon.innerHTML = `
                    <a-box color="#1a1a1a" depth="0.4" height="0.08" width="0.05" position="0 0 -0.1"></a-box>
                    <a-cylinder color="#111" height="0.35" radius="0.015" rotation="90 0 0" position="0 0.02 -0.35"></a-cylinder>
                    <a-box color="#222" depth="0.05" height="0.2" width="0.04" position="0 -0.12 -0.1" rotation="10 0 0"></a-box>
                    <a-box color="#111" depth="0.15" height="0.1" width="0.04" position="0 -0.05 0.2"></a-box>
                `; 
            } else {
                // AK47
                weapon.innerHTML = `
                    <a-box color="#2a2a2a" depth="0.4" height="0.08" width="0.05" position="0 0 -0.1"></a-box>
                    <a-box color="#8B4513" depth="0.2" height="0.06" width="0.055" position="0 0 -0.3"></a-box>
                    <a-cylinder color="#111" height="0.4" radius="0.012" rotation="90 0 0" position="0 0.02 -0.4"></a-cylinder>
                    <a-box color="#333" depth="0.06" height="0.22" width="0.04" position="0 -0.12 -0.15" rotation="25 0 0"></a-box>
                    <a-box color="#8B4513" depth="0.2" height="0.1" width="0.04" position="0 -0.08 0.25" rotation="-15 0 0"></a-box>
                `;
            }
            weapon.setAttribute('rotation', '-10 0 0');
            hand.appendChild(weapon);
        }

        function startGameLoop() {
            // 1. SEND DATA (Local -> Cloud)
            setInterval(() => {
                if(!currentUserId) return;
                
                const head = document.getElementById('local-head');
                const worldRoot = document.getElementById('world-root');

                // MATH: Convert Local Head Position -> Relative to World Root
                // We must store positions RELATIVE to the calibrated center (world-root)
                // so that when other players download them, they display inside THEIR world-root.
                
                const rootWorldInv = new THREE.Matrix4().copy(worldRoot.object3D.matrixWorld).invert();
                const headWorld = head.object3D.matrixWorld;
                
                // Calculate relative matrix
                const relativeMatrix = new THREE.Matrix4().multiplyMatrices(rootWorldInv, headWorld);
                
                // Extract position and rotation from the relative matrix
                const pos = new THREE.Vector3();
                const quat = new THREE.Quaternion();
                const scale = new THREE.Vector3();
                relativeMatrix.decompose(pos, quat, scale);
                
                const rot = new THREE.Euler().setFromQuaternion(quat);

                // Send to Firebase
                db.collection('players').doc(currentUserId).update({
                    x: pos.x, y: pos.y, z: pos.z,
                    rotX: rot.x, rotY: rot.y, rotZ: rot.z,
                    lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                });

            }, 50);

            // 2. RECEIVE DATA (Cloud -> Local)
            db.collection('players').onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.doc.id === currentUserId) return;
                    if (change.type === 'added') createRemotePlayer(change.doc.id, change.doc.data());
                    if (change.type === 'modified') updateRemotePlayer(change.doc.id, change.doc.data());
                    if (change.type === 'removed') removeRemotePlayer(change.doc.id);
                });
            });
        }

        function createRemotePlayer(id, data) {
            // Note: We append to 'remote-players', which is INSIDE 'world-root'
            // This ensures their coordinates (relative to center) appear correctly in OUR room.
            const container = document.getElementById('remote-players');
            
            const el = document.createElement('a-entity');
            el.setAttribute('id', `player-${id}`);
            
            // Indicator
            const indicator = document.createElement('a-entity');
            indicator.setAttribute('position', '0 0.5 0');
            indicator.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 4000; easing: linear');

            if (data.team === 'blue') {
                indicator.setAttribute('mixin', 'blue-indicator');
                if (myTeam === 'red') indicator.setAttribute('visible', false); // Stealth
            } else {
                indicator.setAttribute('mixin', 'red-indicator');
                indicator.setAttribute('visible', true);
            }

            // Weapon Proxy
            const weaponProxy = document.createElement('a-box');
            weaponProxy.setAttribute('color', '#333');
            weaponProxy.setAttribute('depth', 0.4); weaponProxy.setAttribute('height', 0.05); weaponProxy.setAttribute('width', 0.05);
            weaponProxy.setAttribute('position', '0.2 -0.3 -0.3');

            el.appendChild(indicator);
            el.appendChild(weaponProxy);
            container.appendChild(el);
        }

        function updateRemotePlayer(id, data) {
            const el = document.getElementById(`player-${id}`);
            if (el) {
                // Since 'el' is inside #world-root, these X/Y/Z are relative to the anchor
                el.object3D.position.set(data.x, data.y, data.z);
                el.object3D.rotation.set(data.rotX, data.rotY, data.rotZ);
            }
        }

        function removeRemotePlayer(id) {
            const el = document.getElementById(`player-${id}`);
            if (el) el.remove();
        }
    </script>
    <script type="module">
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "AIzaSyCgzwyHW0gPmsdp5sKFPL2WpUqah02OAf4",
          authDomain: "zioneye-prototype.firebaseapp.com",
          projectId: "zioneye-prototype",
          storageBucket: "zioneye-prototype.firebasestorage.app",
          messagingSenderId: "356865086206",
          appId: "1:356865086206:web:d611c8deb6a98070dc0baf",
          measurementId: "G-P1XL9VQN79"
        };
    </script>
</body>
</html>
